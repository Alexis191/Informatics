{% extends 'gestion/base.html' %}

{% block page_title %}Gestión de Productos y Planes{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-menatics" data-bs-toggle="modal" data-bs-target="#modalCrear">
                <i class="fas fa-plus me-2"></i> Nuevo Producto
            </button>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Nombre Plan</th>
                                <th>Facturas/Año</th>
                                <th>Precio ($)</th>
                                <th>Vigencia (Días)</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in productos %}
                            <tr>
                                <td class="ps-4 fw-bold text-secondary">{{ p.nombre_producto }}</td>
                                <td>{{ p.plan_num }}</td>
                                <td>${{ p.precio }}</td>
                                <td>{{ p.vigencia }}</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-1 btn-editar"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditar"
                                            data-id="{{ p.pk }}"
                                            data-nombre="{{ p.nombre_producto }}"
                                            data-plan="{{ p.plan_num }}"
                                            data-precio="{{ p.precio }}"
                                            data-vigencia="{{ p.vigencia }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                    <a href="{% url 'eliminar_producto' p.pk %}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Estás seguro de eliminar este plan?');">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    No hay productos registrados aún.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'guardar_producto' %}" method="POST">
                {% csrf_token %}
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title fw-bold">Nuevo Plan de Facturación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre del Producto</label>
                        <input type="text" name="nombre_producto" class="form-control" required placeholder="Ej: Plan Pymes">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">N° Facturas</label>
                            <input type="number" name="plan_num" class="form-control" required placeholder="Ej: 500">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Precio ($)</label>
                            <input type="number" step="0.01" name="precio" class="form-control" required placeholder="0.00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vigencia (Días)</label>
                        <input type="number" name="vigencia" class="form-control" required value="365">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-menatics">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'editar_producto' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="id_producto" id="edit_id">
                
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">Editar Plan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre del Producto</label>
                        <input type="text" name="nombre_producto" id="edit_nombre" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">N° Facturas</label>
                            <input type="number" name="plan_num" id="edit_plan" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Precio ($)</label>
                            <input type="number" step="0.01" name="precio" id="edit_precio" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vigencia (Días)</label>
                        <input type="number" name="vigencia" id="edit_vigencia" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modalEditar = document.getElementById('modalEditar');
        
        modalEditar.addEventListener('show.bs.modal', function (event) {
            // Botón que activó el modal
            var button = event.relatedTarget;
            
            // Extraer info de los atributos data-*
            var id = button.getAttribute('data-id');
            var nombre = button.getAttribute('data-nombre');
            var plan = button.getAttribute('data-plan');
            var precio = button.getAttribute('data-precio');
            var vigencia = button.getAttribute('data-vigencia'); // Reemplaza la coma decimal si es necesario
            
            // Actualizar los inputs del modal
            document.getElementById('edit_id').value = id;
            document.getElementById('edit_nombre').value = nombre;
            document.getElementById('edit_plan').value = plan;
            
            // Reemplazo simple para asegurar formato numérico correcto en JS
            var precioFormat = precio.replace(',', '.');
            document.getElementById('edit_precio').value = precioFormat;
            
            document.getElementById('edit_vigencia').value = vigencia;
        });
    });
</script>

{% endblock %}